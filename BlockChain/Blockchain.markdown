# 区块链


## Question

计算机底层的网络协议栈
RPC调用的好处

## 区块链概念

区块链总的来说就是一个分布式的账本，任何参与节点都能拥有这个账簿的所有记录，可以追根溯源，同时任何一个节点不能随意改造和伪造



## 区块链技术特点

+ 去中心化/弱中心化:区块链是一种分布式数据存储结构，没有中心节点，所有节点保存全部的相同区块信息，对于特殊的应用场景，可以适当地采用若中心化管理节点。**对于目前的分布式系统来说，更加适用的场景是不完全去中心化，首先我们要考虑到随着交易的数据日渐增多，无法要求客户节点为了使用而事先同步区块链链中的所有信息，这显然增加了客户使用成本。**
+ 不可篡改、可追溯:一致提交后的数据会一直存在，不可被销毁会修改。单个甚至多个节点对数据的篡改无法影响其他节点的数据存储。区块链上记录的信息可以准确地追溯。**区块链在理论上是不可以被销毁或者篡改的，但在实际应用场景中还是存在被销毁或者篡改的可能。许多区块链都基于经济学角度来实现不可篡改(篡改带来的利益远远低于付出的代价)**
+ 透明、去中心化：运行规则和数据信息都是透明的，节点间无须证明身份，无须相互信任。
+ 匿名性:区块链中使用假名技术来切断账号和真实身份的联系。例如:对用户公钥进行一系列hash运算，得到的固有长度的hash值作为对应的电子账号。
+ 隐私保护性:密码学保证了未经授权者能访问到数据，但是无法解析数据。


## 区块链的业务特性

+ 可信任性:区块链技术可以提供天然可信的分布式账本平台，不需要额外第三方中介机构
+ 降低成本:与传统技术相比，区块链技术可能带来更短的时间、更少的人力和维护成本
+ 增强安全:区块链技术将有利于安全可靠的审计管理和账目清算，减少犯罪可能性和各种风险

## 区块链在金融方面的应用

为了确保货币发行、存款、贷款、汇款等大量交易的确定性，银行必须在交易的审核和清算等诸多环节投入大量人力、物力进行核实，这使得交易确认时间长、开销较大。

区块链可以避免人工参与，节省核实时间、流程消耗和人力成本。

由于区块链容量的限制，这些基于区块链的交易系统无法实现海量交易系统所需的性能问题，这个与去中心化网络的不可能三角有关系

## 区块链在征信和权属管理的应用

目前征信权属管理的市场情况是:大量有效数据主要集中在少数机构手中，严格保护。互联网企业从各个维度都获取了海量的用户信息，但从征信角度看，这些数据仍然存在若干问题。①数据量不足，数据量越大，能获得的价值自然越高，而数据产生有效价值存在一个下限，低于下限的数据量无法产生有效价值②、相关度较差，最核心的数据往往是最敏感的，在隐私高度敏感的今天，用户都不希望暴露过多的数据给第三方，因此企业获取到的数据有效成分往往很少。③、时效性不足，企业可以从明面上获取到的用户数据往往是过时的，甚至存在虚假信息，对相关分析的可信度造成严重干扰。但是区块链技术存在获取数据的天然优势；记录数据天然无法篡改、不可抵赖，提供前所未有规模的**相关性极高的数据**，这些数据可以在时空中准确定位，并严格关联到用户，完全依靠数学研究成果，基于区块链的信用机制将天然具备稳定性和中立性。

而权属市场，指的是用于产权、版权等所有权管理和追踪的市场，目前存在的最大几个难题是:物品所有权的确认和管理，保证交易的安全可靠、一定的隐私保护。其对于数据的要求与征信管理类似，因此选用区块链技术能够保证数据的真实安全性和严密性。


## 数字货币

数字货币是一种基于数字技术，依托网络传输，**以非物理形式存在的价值承载和转移的载体**。广义数字货币包括电子货币、虚拟货币、加密货币、数字现金等。侠义的数字货币特指基于区块链和加密运算等技术，依托互联网来创建、发行和实现流通的电子货币，即加密货币，典型代表是以太币和比特币

无论是现金支付还是电子支付，都存在一个共同的问题----去中心化，也就是说他们都是由政府、大企业和公司控制。中心化系统存在很多的问题，例如:容易收到黑客的攻击，信息不透明等。比特币的初衷就是去中心化，它由大量分布式节点构成，没有中心服务器。

人们平时用到的支付系统，如支付宝是由中心服务器存储用户的每一笔花销，即可以将他看作一个账本，这个账本记录了所有用户的每笔交易。这需要中心系统有很大的存储空间和较快的处理速度。而比特币是由各个节点来处理每一笔交易，而这些节点都是分布在全世界各个地方，这种分布式架构完全没有传统中心化网络的问题。


在分布式系统中，每个节点都各自运行自己的处理程序，如何保证系统准确无误地记录每一笔交易?这就是区块链技术要解决的问题。节点将交易信息打包进区块中，并连接前一个区块，就组成了区块链。整个区块链系统可以看作一个完整的账本。这里存在几个问题:交易信息由哪个节点记录?如何保证记录交易的准确性?每个区块怎么存储交易信息并与上一个区块连接？每个账户怎么记录余额？

在比特币系统中，每个用户都有一个地址存储自己的比特币，这个地址叫做钱包。实际上钱包就是由一串密码控制的地址。用户每次交易时都需要提供对应钱包的密码，交易就是比特币由一个地址转移到另一个地址上。在用户发起交易后，整个网络的节点都会收到这笔交易的请求，但是不是任何节点都有能力来记录交易(交易上链)，比特币系统通过工作量证明来解决交易记录问题。



## 区块链基础理论

**区块链从本质上来说是一个异地多活分布式数据库**，里面存储了所有被网络认可的交易信息，所以可以将其理解为比特币交易信息的巨大账本，而且这个大账本被网络中的所有节点备份。也正式由于这个公共大账本的存在，才保证了无第三方存在的情况下，卖家和买家可以进行诚信交易

比特币并非区块链的唯一用处，也并非所有区块链生态系统都需要完全相同的机制。实际上区块链作为一种分布式数据库，包含了许多技术和原理。例如比特币区块链、以太坊区块链和智能合约，基于不同的应用场景，即使均采用相似的区块链技术，也会有不同的结果。事实上，区块链技术包括许多技术模块，如数字签名、各种密码学原理、共识机制、数据存储和分发、安全防卫等，可以根据应用场景进行组装。

区块链通过新的数据结构、分布式共识机制、哈希加密算法以及独特的运行机制，使得去中心化的信任构想成为现实。简单来说，区块链就是一个分布式多备份的公共大账本，帐本中记录了从比特币产生到目前为止的每一笔比特币交易，账本存储在节点中。


侠义的区块链技术一般说的是具体产品应用中的数据存储思想和方式，类似区块链在比特币中的作用。但随着区块链技术和不同场景的深入结合，单独再说到区块链，更多指的是一种数据公开透明、可追溯、不可篡改的产品架构设计。区块链网络通过结合点对点网络设计，加密技术，数据存储技术，分布式算法等多种技术和协议为数据部署和存储赋予了新的定义。

类比OSI七层协议，可将区块链系统分为六层，分别是应用层、合约层、激励层、共识层、网络层、数据层。


 + 数据层
 
>   数据层封装了区块链的底层数据存储和加密技术。每个节点存储的本  地区块链副本可以被看作三个级别的分层数据结构，即交易、区块和链。每个级别都需要不同的加密功能来保证数据的完整性和真实性
交易是区块链的原子数据结构。通常，交易由一组用户或类似智能合>约的自主对象创建，完成代币从发送者到指定接收者的转移。为了保证交>易记录的完整性，数据层中包含了哈希函数和非对称加密的功能。
>    
>    哈希函数又称为加密散列函数，能够实现将任意长度的二进制输出
>    映射到唯一固定长度的二进制输出。哈希函数的计算具有不可逆性，>根据输出恢复输入是不可行的，同时，两个不同的输入生成相同的输出概>率可以忽略不计
>     
>    非对称加密功能主要指的是在交易过程中使用的公钥和私钥，网络
>    中的每一个节点都会生成一对私钥和公钥。私钥与数字签名的功能相关联，数字签名通过一串他人无法伪造的字符串证明交易发送方的身
>     份。公钥与数字签名的验证相关，只有通过对应私钥生成的数字签
>     名经过验证后才会返回ture。另外，网络中的节点还会通过公钥生成的字符串作为区块链上的永久地址识别自身。 
>     
>    区块是交易记录的任意子集的聚合，只有参与建立网络共识过程的
>    节点才能进行创建。例如在比特币网络中，只有具有矿工功能节点才有资格进行新区块的创建。为了保证交易记录的完整性，同时在共识 
>    节点的本地存储中按照指定顺序进行区块间的排序，使用了哈希指
>    针的数据字段保存在区块的数据结构中。为了减少单笔交易的存储占 比，增大容量，同时防止交易记录被篡改，采用了Merkle树的结构
>     
>    区块中的哈希指针字段，又被称为父哈希。将上一区块的哈希码存储为当前区块的指针，区块通过哈希指针实现链状结构。哈希指针不仅可
>    以指向数据存储位置，还可以明晰某个时间戳下该数据的哈希值。一旦数据被篡改，哈希指针能即时放映出来。
>     
>    Merkle树通过二叉树的形式存储交易数据，每个叶子节点均为交易
>    的哈希编码，非叶子节点使用相连的两个子节点的哈希码的连接标
>    记。所有交易信息最终以Merkle根的形式存储到区块头中，其中，
>    **仅存储Merkle根的区块为轻量级形式，以便进行快速验证和数据同步**

> 除了哈希指针，Merkle树和区块头之外，区块中还包含一些辅助数据字段，其定义根据所采用的不同的共识方案的区块生协议而变化。实际上，区块间呈现的结构主要取决于**单个区块保留的前驱哈希指针的数量**，区块网络可以为线性链表，也可以是有向无环图。

+ 网络层

> 网络层涉及到区块链网络中的分布式点对点网络和网络节点连接与网络运转所需要传播和验证机制。
>
>在拜占庭环境中,身份管理机制在确认区块链网络中的节点组织模式上起着关键作用。在无权限限制的公开区块链网络中，节点可以选择自由加入网络并激活网络中的任何可用功能。在没有任何身份鉴别方案的情况下，区块链网络被组织为覆盖P2P网络。但是不同应用场景对于区块链去中心化和开放程度有不同要求，据此可以将区块链大致分为公有链、私有链、联盟链
>
> 公有链的去中心化程度最高，这种区块链完全不存在把控的中心化机构或者组织，任何人都能读取链上数据、参与交易和算力竞争
>
>私有链的门槛最高，权限完全由某个组织或者机构控制，数据读取和写入受到组织制定规则的严格限制，多适用于特定机构的内部使用。私有链不同于公有链，中心化程度较高，可以理解为一个弱中心化或多中心化的系统。由于加入门槛最高，私有链的节点数量被严格控制，较少的节点数量也就代表着更短的交易时间、更高的交易速率和更低的算力竞争成本
>
>联盟链介于公有链和私有链之间，是一种实现了部分去中心化的系统。从某种意义上来说，联盟链是开放程度更高的私有链，节点的参与和维护对象是线下因为某种利益关系组成的联盟，这些对象共同加入了一个相同的网络并维护其运行
>
>相较之下，联盟链仅允许授权节点启用核心功能，例如参与共识机制或数据传播。根据网络的共识协议不同，授权节点被组织在不同的拓扑结构中，可以是全连接的网络，也可以是p2p网络。
>
>网络层的主要目标是在节点间引入随机拓扑结构，同时实现区块链更新信息的有效传播和本地同步。大多数现有的区块链网络采用的均为即用型P2P协议，只对拓扑结构和数据通信略加修改。在对等节点发现和拓扑结构维护上，不同的区块链网络采用的方式不同。比特币网络中有一个"种子节点"列表，种子节点指的是长期稳定运行的节点，新节点可以通过与种子节点建立连接来快速发现网络中的其他节点，而这些种子节点可以是由比特币客户端维持，也由比特币社区成员维护。在以太坊区块链网络中，采用了基于哈希表的Kademlia协议，通过UDP连接进行对等节点或路由发现。
>
>通常，区块链网络的P2P链路建立在通过握手通信过程建立持久TCP连接的基础上，节点间通过握手协议交换存储区状态和使用协议、软件版本等信息。在比特币网络中，当建立一个或多个连接之后，新节点将包含自身IP地址的addr信息发送给相邻节点，相邻节点再将该信息转发给他们各自的相邻节点，从而完成新节点的信息被多个节点接收，同时新节点通过getaddr消息要求相邻节点发送已知对等节点的IP信息列表。节点也是通过握手协议与其邻居节点完成交易、新区快信息的交换。区块链中的信息传输通常是基于HTTP的RPC协议实现，其中消息按照JSON协议进行序列化。

+ 共识层

> 共识层主要指的是不同区块链网络中使用的共识算法，如工作量证明，权益证明，拜占庭容错算法。
> 
> 在分布式系统中，维护基于P2P网络的区块链的规范状态可映射为容错状态机的复制问题。换句话说，区块链的独特的共识协议是由拜占庭将军条件下的网络共识节点实现。在区块链网络中，拜占庭将军问题导致故障节点可能出现的任意行为，拜占庭节点的任意行为除了可能会误导其他副本节点，还会产生更大的危害，而不仅仅是宕机失去响应，如恶意攻击(女巫攻击或双重攻击)、节点错误(由于软件版本不同导致意外的区块链分叉)和连接错误。如果简单将区块的序号表示区块链的状态，交易得到确认时区块状态发生变化，在拜占庭环境中，只有满足共识协议中的条例内容，才能认为网络达成共识，包括:在公共区块链网络中，被纳入区块的所有交易都需经过诚实节点的最终确认验证，新区块只有被所有诚实节点验证通过才能被纳入区块链中；被采纳的新区块实现了对网络中现有链条的顺序延长；诚实节点认同验证通过区块中的交易顺序
> 
> 共识协议因不同的区块链网络而存在差异。对于公有链，需要对参与公司的节点间进行更为严格的信息同步控制。 