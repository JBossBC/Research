# Hardware

## Question

EL2、EL3?
内核，外核？


###  指令集架构是CPU和软件之间的桥梁.ISA包含指令集、特权级、寄存器、执行模式、安全扩展、性能加速扩展等诸多方面。

选择AArch64体系结构

+ 指令集是ISA的重要组成部分，通常包含一系列不同功能的指令，用于数据搬移、计算、内存访问、过程调用等。CPU在运行操作系统或应用程序时，实际上是在执行他们被编译后所包含的指令。AArch64的指令集属于精简指令集计算机。每条指令长度为4byte，指令类型包括:
     + 数据搬移指令
     + 寄存器计算指令
     + 内存读写指令
     + 跳转指令
     + 过程调用指令
     + 特权指令
     

+ 特权级
  
  AArch64中的特权级被称为异常级别，共有四种特权级
     
     + EL0:最低的特权级，应用程序通常运行在该特权级，也称为用户态
     + EL1:操作系统通常运行在该特权级，也成为内核态
     + EL2:在虚拟化场景中需要，虚拟机监控器通常运行在该特权级
     + EL3:和安全特性TrustZone相关，负责普通世界和安全世界之间的切换

  CPU在提供了四种特权级的同时也提供了特权级之间切换的方式。由于通常应用程序运行在EL0而操作系统运行在EL1,所以常见的就是EL0与EL1之间的特权切换

      1. 应用程序需要调用操作系统提供的系统调用，此时应用程序会通过执行svc(特权调用)指令将CPU特权级从EL0切换到EL1
      2. 应用程序执行了一条指令，而该指令触发了异常，该异常导致CPU从EL0切换到EL1。例如，应用在执行一条访存指令时，出发了缺页异常，从而切换到操作系统内核进行处理
      3. 应用程序在执行的过程中，CPU收到一个来自外设的中断，该中断也会导致CPU特权级从EL0切换到EL1。
  

当程序在EL0下正常运行的时候，CPU发生中断或异常，寄存器会保存错误信息和处理器状态(ELR(异常链接寄存器)和ESR(异常症状寄存器))同时进入EL1，在EL1下面查询异常向量表并选择相应的handle进行处理，从handle返回然后切换回EL0继续执行。


在EL1特权级下面有两个页表基地址存储器，即TTBR0_EL1和TTBR1-EL1,他们负责翻译虚拟地址空间中不同地址段，负责的地址范围由另一个控制寄存器TCR_EL1(翻译控制寄存器)决定。操作系统中一种常见的配置是TTBR0_EL1负责[0,2^48)的地址(作为用户地址空间)，TTBR1_EL1负责[2^48,2^64)的地址映射(作为操作系统内核地址空间以及保留空间)
